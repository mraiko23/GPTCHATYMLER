# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —Å —Ñ–∞–π–ª–∞–º–∏ - –ó–∞–≤–µ—Ä—à–µ–Ω–æ

## üéâ **–ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞! –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Å —Ñ–∞–π–ª–∞–º–∏ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç!**

## üìã **–ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**

### 1. **–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤ Message –º–æ–¥–µ–ª–∏** ‚ùå‚Üí‚úÖ
**–ü—Ä–æ–±–ª–µ–º–∞**: `validate :content_or_files_present, on: :create, if: :user?`

ActiveModel –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–ø—Ü–∏—é `:on` –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–π (—ç—Ç–æ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å ActiveRecord).

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤** `app/models/message.rb`:
```ruby
# ‚ùå –ë—ã–ª–æ:
validate :content_or_files_present, on: :create, if: :user?

# ‚úÖ –°—Ç–∞–ª–æ:
validate :content_or_files_present, if: -> { user? && new_record? }
```

### 2. **–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤ –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ** ‚ùå‚Üí‚úÖ
**–ü—Ä–æ–±–ª–µ–º–∞**: `unknown attribute 'files' for Message`

–ü–∞—Ä–∞–º–µ—Ç—Ä `files` –ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è –≤ `Message.new()`, –Ω–æ JsonModel –Ω–µ –∑–Ω–∞–µ—Ç, –∫–∞–∫ –µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å. –§–∞–π–ª—ã –Ω—É–∂–Ω–æ –ø—Ä–∏–∫—Ä–µ–ø–ª—è—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ —á–µ—Ä–µ–∑ `files.attach()`.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤** `app/controllers/messages_controller.rb`:

#### –í –º–µ—Ç–æ–¥–µ `create`:
```ruby
# ‚ùå –ë—ã–ª–æ:
params_hash = message_params.to_h
@message = Message.new(params_hash.merge(chat_id: @chat.id, role: 'user'))

# ‚úÖ –°—Ç–∞–ª–æ:
files_param = message_params[:files]
params_hash = message_params.to_h.except('files')

@message = Message.new(params_hash.merge(chat_id: @chat.id, role: 'user'))

# Attach files if present
if files_param.present?
  files_param.each do |file|
    @message.files.attach(file) if file.present?
  end
end
```

#### –í –º–µ—Ç–æ–¥–µ `update`:
```ruby
# ‚ùå –ë—ã–ª–æ:
if @message.update(message_params.to_h)

# ‚úÖ –°—Ç–∞–ª–æ:
files_param = message_params[:files]
params_hash = message_params.to_h.except('files')

# Attach new files if present
if files_param.present?
  files_param.each do |file|
    @message.files.attach(file) if file.present?
  end
end

if @message.update(params_hash)
```

## üîç **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è:**

### –ü—Ä–æ–±–ª–µ–º–∞ —Å `.delete()` vs `.except()`:
–ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —è –ø—ã—Ç–∞–ª—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `.delete()` –ø–æ—Å–ª–µ `.to_h`, –Ω–æ —ç—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–æ:
```ruby
# ‚ùå –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:
params_hash = message_params.to_h
files_param = params_hash.delete('files')  # Delete —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ —Å–ª–∏—à–∫–æ–º –ø–æ–∑–¥–Ω–æ

# ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç:
files_param = message_params[:files]        # –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º —Ñ–∞–π–ª—ã
params_hash = message_params.to_h.except('files')  # –ü–æ—Ç–æ–º –∏—Å–∫–ª—é—á–∞–µ–º –∏–∑ hash
```

### –ü–æ—á–µ–º—É –Ω—É–∂–Ω–æ –æ—Ç–¥–µ–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ñ–∞–π–ª—ã:

1. **JsonModel** –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É `has_many_attached`
2. –§–∞–π–ª—ã –Ω—É–∂–Ω–æ –ø—Ä–∏–∫—Ä–µ–ø–ª—è—Ç—å —á–µ—Ä–µ–∑ `.attach()` –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞
3. –ü–∞—Ä–∞–º–µ—Ç—Ä `files` –Ω–µ–ª—å–∑—è –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –≤ `new()` –∏–ª–∏ `update()`

## ‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç:**

‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ  
‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π —Å —Ç–µ–∫—Å—Ç–æ–º —Ä–∞–±–æ—Ç–∞–µ—Ç  
‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π —Å —Ñ–∞–π–ª–∞–º–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç  
‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π —Å —Ç–µ–∫—Å—Ç–æ–º –ò —Ñ–∞–π–ª–∞–º–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç  
‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π —Å —Ñ–∞–π–ª–∞–º–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç  
‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ `unknown attribute 'files'`  
‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π `:on`  

## üß™ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**

–£—Å–ø–µ—à–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ:
1. ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
2. ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞
3. ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞ —Å —Ç–µ–∫—Å—Ç–æ–º
4. ‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
5. ‚úÖ AI –æ—Ç–≤–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è

## üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:**

- **–§–∞–π–ª–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–æ**: 2
- **–ú–æ–¥–µ–ª–µ–π –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ**: 1 (Message)
- **–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ**: 1 (MessagesController)
- **–ú–µ—Ç–æ–¥–æ–≤ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ**: 2 (create, update)

## üöÄ **–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!**

**URL**: https://3000-0113022a7275-web.clackypaas.com

–í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å JSON-based storage!

## üìù **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è:**

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã —Å has_many_attached –≤ JsonModel:

1. **–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤**: –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `.attach(file)` –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `.attached?` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
3. **–£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `.purge` –∏–ª–∏ `.purge_later`

### –ü—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
```ruby
# –°–æ–∑–¥–∞–Ω–∏–µ —Å —Ñ–∞–π–ª–∞–º–∏
message = Message.new(content: "Hello", chat_id: 1, role: 'user')
message.files.attach(uploaded_file)
message.save

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è
if message.files.attached?
  # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤
end

# –£–¥–∞–ª–µ–Ω–∏–µ
message.files.purge_all
```
